<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Exámenes</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #4a6da7;
            --secondary-color: #304878;
            --accent-color: #ff6b6b;
            --background-color: #f5f7fa;
            --text-color: #333;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: center;
            margin-top: 10px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .option {
            display: block;
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }
        
        .option:hover {
            background-color: #f0f0f0;
        }
        
        .option.selected {
            background-color: #e3f2fd;
            border-color: var(--primary-color);
        }
        
        .question-container {
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .timer {
            font-size: 20px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .progress {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            width: auto;
            margin-right: 8px;
            margin-bottom: 0;
        }
        
        .results-container {
            text-align: center;
        }
        
        .results-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .score {
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .hidden {
            display: none;
        }
        
        /* Estilos para los botones de gestión de banco de preguntas */
        .admin-button {
            background-color: var(--secondary-color);
            margin-top: 20px;
        }
        
        .admin-section {
            margin-top: 30px;
        }
        
        .question-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .question-list {
            margin-top: 20px;
        }
        
        .question-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .delete-btn {
            background-color: var(--accent-color);
            padding: 5px 10px;
            position: absolute;
            right: 10px;
            top: 10px;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls button {
                margin-bottom: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div id="startScreen" class="container">
        <h1>Aplicación de Exámenes</h1>
        
        <div>
            <label for="num-questions">Número de preguntas:</label>
            <input type="number" id="num-questions" min="1" max="100" value="50">
            
            <label>Selecciona los temas:</label>
            <div id="themes-container" class="checkbox-container"></div>
            
            <button id="start-exam">Iniciar Examen</button>
            <button id="manage-questions" class="admin-button">Gestionar Banco de Preguntas</button>
        </div>
    </div>
    
    <!-- Pantalla de examen -->
    <div id="examScreen" class="hidden">
        <div class="timer" id="timer">60:00</div>
        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div id="question-container" class="container question-container">
            <h2 id="question-text">Pregunta</h2>
            <p id="question-theme" style="color: var(--secondary-color); margin-bottom: 15px;"></p>
            
            <div id="options-container">
                <div class="option" data-index="0">Opción 1</div>
                <div class="option" data-index="1">Opción 2</div>
                <div class="option" data-index="2">Opción 3</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="prev-button">Anterior</button>
            <button id="next-button">Siguiente</button>
            <button id="finish-button">Finalizar Examen</button>
        </div>
    </div>
    
    <!-- Pantalla de resultados -->
    <div id="resultsScreen" class="hidden">
        <div class="container results-container">
            <h2>Resultados del Examen</h2>
            
            <div class="score" id="final-score">Puntuación: 0/10</div>
            
            <div class="stats">
                <div class="stat-item">
                    <div>Aciertos</div>
                    <div class="stat-value" id="correct-answers">0</div>
                </div>
                <div class="stat-item">
                    <div>Errores</div>
                    <div class="stat-value" id="wrong-answers">0</div>
                </div>
                <div class="stat-item">
                    <div>Sin responder</div>
                    <div class="stat-value" id="unanswered">0</div>
                </div>
            </div>
            
            <button id="restart-button">Volver al Inicio</button>
            <button id="review-button">Revisar Respuestas</button>
        </div>
    </div>
    
    <!-- Pantalla de gestión de banco de preguntas -->
    <div id="questionBankScreen" class="hidden">
        <div class="container">
            <h2>Gestión del Banco de Preguntas</h2>
            
            <div class="question-form">
                <h3>Añadir Nueva Pregunta</h3>
                
                <label for="new-theme">Tema:</label>
                <input type="text" id="new-theme" list="existing-themes">
                <datalist id="existing-themes"></datalist>
                
                <label for="new-question">Pregunta:</label>
                <input type="text" id="new-question">
                
                <label for="option1">Opción 1:</label>
                <input type="text" id="option1">
                
                <label for="option2">Opción 2:</label>
                <input type="text" id="option2">
                
                <label for="option3">Opción 3:</label>
                <input type="text" id="option3">
                
                <label for="correct-option">Respuesta Correcta:</label>
                <select id="correct-option">
                    <option value="0">Opción 1</option>
                    <option value="1">Opción 2</option>
                    <option value="2">Opción 3</option>
                </select>
                
                <button id="add-question">Añadir Pregunta</button>
            </div>
            
            <label for="filter-theme">Filtrar por tema:</label>
            <select id="filter-theme">
                <option value="all">Todos los temas</option>
            </select>
            
            <div id="question-list" class="question-list"></div>
            
            <button id="back-to-start">Volver al Inicio</button>
        </div>
    </div>
    
    <script>
        // Modelo de datos
        let questionBank = [];
        let examQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let examTime = 0;
        let timer;
        let secondsLeft = 0;
        
        // Obtener elementos del DOM
        const startScreen = document.getElementById('startScreen');
        const examScreen = document.getElementById('examScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const questionBankScreen = document.getElementById('questionBankScreen');
        
        const numQuestionsInput = document.getElementById('num-questions');
        const themesContainer = document.getElementById('themes-container');
        const startExamButton = document.getElementById('start-exam');
        const manageQuestionsButton = document.getElementById('manage-questions');
        
        const timerElement = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const questionTheme = document.getElementById('question-theme');
        const optionsContainer = document.getElementById('options-container');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const finishButton = document.getElementById('finish-button');
        
        const finalScore = document.getElementById('final-score');
        const correctAnswers = document.getElementById('correct-answers');
        const wrongAnswers = document.getElementById('wrong-answers');
        const unanswered = document.getElementById('unanswered');
        const restartButton = document.getElementById('restart-button');
        const reviewButton = document.getElementById('review-button');
        
        const newThemeInput = document.getElementById('new-theme');
        const newQuestionInput = document.getElementById('new-question');
        const option1Input = document.getElementById('option1');
        const option2Input = document.getElementById('option2');
        const option3Input = document.getElementById('option3');
        const correctOptionSelect = document.getElementById('correct-option');
        const addQuestionButton = document.getElementById('add-question');
        const existingThemesDatalist = document.getElementById('existing-themes');
        const filterThemeSelect = document.getElementById('filter-theme');
        const questionList = document.getElementById('question-list');
        const backToStartButton = document.getElementById('back-to-start');
        
        // Cargar banco de preguntas del localStorage
        function loadQuestionBank() {
            const savedBank = localStorage.getItem('questionBank');
            if (savedBank) {
                questionBank = JSON.parse(savedBank);
            } else {
                // Si no hay banco de preguntas, cargar algunos ejemplos
                questionBank = [
                    {
                        theme: 'Historia',
                        question: '¿En qué año comenzó la Segunda Guerra Mundial?',
                        options: ['1939', '1941', '1945'],
                        correctOption: 0
                    },
                    {
                        theme: 'Historia',
                        question: '¿Quién fue el primer presidente de los Estados Unidos?',
                        options: ['Thomas Jefferson', 'George Washington', 'Abraham Lincoln'],
                        correctOption: 1
                    },
                    {
                        theme: 'Ciencias',
                        question: '¿Cuál es el símbolo químico del oro?',
                        options: ['Ag', 'Au', 'Fe'],
                        correctOption: 1
                    },
                    {
                        theme: 'Ciencias',
                        question: '¿Cuál es el planeta más grande del sistema solar?',
                        options: ['Tierra', 'Júpiter', 'Saturno'],
                        correctOption: 1
                    },
                    {
                        theme: 'Matemáticas',
                        question: '¿Cuánto es 9 × 9?',
                        options: ['81', '90', '99'],
                        correctOption: 0
                    },
                    {
                        theme: 'Matemáticas',
                        question: '¿Cuál es el valor de π (pi) aproximado a dos decimales?',
                        options: ['3.14', '3.41', '3.16'],
                        correctOption: 0
                    }
                ];
                saveQuestionBank();
            }
        }
        
        // Guardar banco de preguntas en localStorage
        function saveQuestionBank() {
            localStorage.setItem('questionBank', JSON.stringify(questionBank));
        }
        
        // Cargar temas disponibles
        function loadThemes() {
            const themes = [...new Set(questionBank.map(q => q.theme))];
            
            // Limpiar contenedor de temas
            themesContainer.innerHTML = '';
            
            // Crear checkboxes para cada tema
            themes.forEach(theme => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `theme-${theme}`;
                checkbox.value = theme;
                checkbox.checked = true;
                
                const label = document.createElement('label');
                label.htmlFor = `theme-${theme}`;
                label.textContent = theme;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                themesContainer.appendChild(checkboxItem);
            });
            
            // Actualizar datalist de temas existentes
            existingThemesDatalist.innerHTML = '';
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme;
                existingThemesDatalist.appendChild(option);
            });
            
            // Actualizar select de filtrado
            const currentValue = filterThemeSelect.value;
            filterThemeSelect.innerHTML = '<option value="all">Todos los temas</option>';
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme;
                option.textContent = theme;
                filterThemeSelect.appendChild(option);
            });
            filterThemeSelect.value = currentValue;
        }
        
        // Generar examen
        function generateExam() {
            const numQuestions = parseInt(numQuestionsInput.value);
            
            // Obtener temas seleccionados
            const selectedThemes = Array.from(themesContainer.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedThemes.length === 0) {
                alert('Por favor, selecciona al menos un tema');
                return false;
            }
            
            // Filtrar preguntas por temas seleccionados
            const availableQuestions = questionBank.filter(q => selectedThemes.includes(q.theme));
            
            if (availableQuestions.length === 0) {
                alert('No hay preguntas disponibles para los temas seleccionados');
                return false;
            }
            
            if (availableQuestions.length < numQuestions) {
                alert(`Solo hay ${availableQuestions.length} preguntas disponibles. Reduce el número de preguntas o añade más al banco.`);
                return false;
            }
            
            // Agrupar preguntas por tema
            const questionsByTheme = {};
            selectedThemes.forEach(theme => {
                questionsByTheme[theme] = availableQuestions.filter(q => q.theme === theme);
            });
            
            // Calcular cuántas preguntas por tema para distribuir equitativamente
            const questionsPerTheme = Math.floor(numQuestions / selectedThemes.length);
            let remainingQuestions = numQuestions - (questionsPerTheme * selectedThemes.length);
            
            // Seleccionar preguntas ponderando por tema
            examQuestions = [];
            
            selectedThemes.forEach(theme => {
                // Determinar cuántas preguntas seleccionar de este tema
                let numToSelect = questionsPerTheme;
                if (remainingQuestions > 0) {
                    numToSelect++;
                    remainingQuestions--;
                }
                
                // Asegurarse de que no se seleccionen más preguntas de las disponibles
                numToSelect = Math.min(numToSelect, questionsByTheme[theme].length);
                
                // Seleccionar preguntas aleatoriamente
                const themeQuestions = [...questionsByTheme[theme]];
                for (let i = 0; i < numToSelect; i++) {
                    const randomIndex = Math.floor(Math.random() * themeQuestions.length);
                    examQuestions.push(themeQuestions[randomIndex]);
                    themeQuestions.splice(randomIndex, 1);
                }
            });
            
            // Mezclar las preguntas
            examQuestions = shuffleArray(examQuestions);
            
            // Inicializar respuestas del usuario
            userAnswers = Array(examQuestions.length).fill(null);
            
            // Calcular tiempo de examen (proporcional a 60 minutos para 50 preguntas)
            examTime = Math.ceil((numQuestions / 50) * 60);
            secondsLeft = examTime * 60;
            
            return true;
        }
        
        // Mostrar la pregunta actual
        function showCurrentQuestion() {
            const currentQuestion = examQuestions[currentQuestionIndex];
            
            questionText.textContent = `${currentQuestionIndex + 1}. ${currentQuestion.question}`;
            questionTheme.textContent = `Tema: ${currentQuestion.theme}`;
            
            // Actualizar opciones
            const options = optionsContainer.querySelectorAll('.option');
            options.forEach((option, index) => {
                option.textContent = currentQuestion.options[index];
                
                // Marcar la opción seleccionada por el usuario
                if (userAnswers[currentQuestionIndex] === index) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Actualizar botones de navegación
            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.disabled = currentQuestionIndex === examQuestions.length - 1;
            
            // Actualizar barra de progreso
            const progress = ((currentQuestionIndex + 1) / examQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        // Actualizar el temporizador
        function updateTimer() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (secondsLeft <= 0) {
                clearInterval(timer);
                finishExam();
            } else {
                secondsLeft--;
            }
        }
        
        // Calcular la puntuación del examen
        function calculateScore() {
            const numQuestions = examQuestions.length;
            const pointsPerQuestion = 10 / numQuestions;
            
            let correct = 0;
            let wrong = 0;
            let notAnswered = 0;
            
            userAnswers.forEach((answer, index) => {
                if (answer === null) {
                    notAnswered++;
                } else if (answer === examQuestions[index].correctOption) {
                    correct++;
                } else {
                    wrong++;
                }
            });
            
            // Calcular puntuación (acierto: 0.2, error: -0.1, en blanco: 0)
            // Estos valores son para un examen de 50 preguntas, ajustar proporcionalmente
            const correctPoints = (0.2 * 50 / numQuestions) * correct;
            const wrongPoints = (0.1 * 50 / numQuestions) * wrong;
            
            const totalScore = correctPoints - wrongPoints;
            const normalizedScore = Math.max(0, totalScore).toFixed(2);
            
            return {
                score: normalizedScore,
                correct,
                wrong,
                notAnswered
            };
        }
        
        // Finalizar el examen
        function finishExam() {
            clearInterval(timer);
            
            const results = calculateScore();
            
            finalScore.textContent = `Puntuación: ${results.score}/10`;
            correctAnswers.textContent = results.correct;
            wrongAnswers.textContent = results.wrong;
            unanswered.textContent = results.notAnswered;
            
            examScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
        }
        
        // Función para mezclar array (algoritmo Fisher-Yates)
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // Mostrar la lista de preguntas en la pantalla de gestión
        function showQuestionList() {
            const filterTheme = filterThemeSelect.value;
            
            // Filtrar preguntas por tema si es necesario
            const filteredQuestions = filterTheme === 'all' 
                ? questionBank 
                : questionBank.filter(q => q.theme === filterTheme);
            
            // Limpiar lista de preguntas
            questionList.innerHTML = '';
            
            // Añadir cada pregunta a la lista
            filteredQuestions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                
                const questionContent = document.createElement('div');
                questionContent.innerHTML = `
                    <strong>${question.theme}</strong>: ${question.question}<br>
                    <small>Opciones: 1) ${question.options[0]} | 2) ${question.options[1]} | 3) ${question.options[2]}</small><br>
                    <small>Respuesta correcta: ${parseInt(question.correctOption) + 1}</small>
                `;
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn';
                deleteButton.textContent = 'Eliminar';
                deleteButton.addEventListener('click', () => {
                    // Encontrar el índice real en el banco de preguntas
                    const realIndex = questionBank.findIndex(q => 
                        q.question === question.question && 
                        q.theme === question.theme && 
                        q.options.join() === question.options.join() &&
                        q.correctOption === question.correctOption
                    );
                    
                    if (realIndex !== -1) {
                        questionBank.splice(realIndex, 1);
                        saveQuestionBank();
                        loadThemes();
                        showQuestionList();
                    }
                });
                
                questionItem.appendChild(questionContent);
                questionItem.appendChild(deleteButton);
                questionList.appendChild(questionItem);
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar banco de preguntas
            loadQuestionBank();
            loadThemes();
            
            // Botón para iniciar examen
            startExamButton.addEventListener('click', () => {
                if (generateExam()) {
                    startScreen.classList.add('hidden');
                    examScreen.classList.remove('hidden');
                    
                    // Mostrar primera pregunta
                    currentQuestionIndex = 0;
                    showCurrentQuestion();
                    
                    // Iniciar temporizador
                    updateTimer();
                    timer = setInterval(updateTimer, 1000);
                }
            });
            
            // Botón para gestionar banco de preguntas
            manageQuestionsButton.addEventListener('click', () => {
                startScreen.classList.add('hidden');
                questionBankScreen.classList.remove('hidden');
                showQuestionList();
            });
            
            // Opciones de respuesta
            optionsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('option')) {
                    // Desmarcar todas las opciones
                    const options = optionsContainer.querySelectorAll('.option');
                    options.forEach(option => option.classList.remove('selected'));
                    
                    // Marcar la opción seleccionada
                    e.target.classList.add('selected');
                    
                    // Guardar respuesta
                    userAnswers[currentQuestionIndex] = parseInt(e.target.dataset.index);
                }
            });
            
            // Botones de navegación
            prevButton.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    showCurrentQuestion();
                }
            });
            
            nextButton.addEventListener('click', () => {
                if (currentQuestionIndex < examQuestions.length - 1) {
                    currentQuestionIndex++;
                    showCurrentQuestion();
                }
            });
            
            // Botón finalizar examen
            finishButton.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que deseas finalizar el examen?')) {
                    finishExam();
                }
            });
            
            // Botón volver al inicio
            restartButton.addEventListener('click', () => {
                resultsScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            });
            
            // Botón revisar respuestas
            reviewButton.addEventListener('click', () => {
                // Implementación pendiente (opcional)
                alert('Funcionalidad en desarrollo');
            });
            
            // Añadir nueva pregunta
            addQuestionButton.addEventListener('click', () => {
                const theme = newThemeInput.value.trim();
                const question = newQuestionInput.value.trim();
                const option1 = option1Input.value.trim();
                const option2 = option2Input.value.trim();
                const option3 = option3Input.value.trim();
                const correctOption = parseInt(correctOptionSelect.value);
                
                if (!theme || !question || !option1 || !option2 || !option3) {
                    alert('Por favor, completa todos los campos');
                    return;
                }
                
                // Añadir nueva pregunta
                questionBank.push({
                    theme,
                    question,
                    options: [option1, option2, option3],
                    correctOption
                });
                
                // Guardar y actualizar
                saveQuestionBank();
                loadThemes();
                showQuestionList();
                
                // Limpiar formulario
                newQuestionInput.value = '';
                option1Input.value = '';
                option2Input.value = '';
                option3Input.value = '';
                correctOptionSelect.value = '0';
            });
            
            // Filtrar preguntas por tema
            filterThemeSelect.addEventListener('change', showQuestionList);
            
            // Volver al inicio
            backToStartButton.addEventListener('click', () => {
                questionBankScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            });
        });
        
        // Registro del Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('Service Worker registrado');
                }).catch(error => {
                    console.log('Error al registrar el Service Worker:', error);
                });
            });
        }
    </script>
</body>
</html>
